---
/**
 * Analytics Dashboard Page
 *
 * This page displays analytics and insights about GitHub repository activity.
 * Integrates with Analytics Engine and GitHub data for real-time insights.
 */

import PageLayout from '../../components/layouts/PageLayout.astro';
import PageHeader from '../../components/ui/PageHeader.astro';
import {
  IssueTrendsChart,
  IssueCategoriesChart,
  ResolutionTimeChart,
  ContributorActivityChart,
} from '../../components/charts/AnalyticsCharts.tsx';

import { getIssuesWithFallback, hasStaticData, getStaticMetadata } from '../../lib/data/github';
import {
  calculateMetrics,
  convertIssuesTrendData,
  convertCategoriesData,
  convertResolutionTimeData,
  convertContributorData,
  generateRecentActivity,
  formatTimeAgo,
} from '../../lib/analytics/data-adapter';
import type { Issue } from '../../lib/schemas/github';
import { resolveUrl } from '../../lib/utils/url';

const title = 'ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰';
const description = 'GitHubãƒªãƒã‚¸ãƒˆãƒªæ´»å‹•ã®åˆ†æã¨æ´å¯Ÿã‚’è¡¨ç¤º';

const breadcrumbs = [
  { name: 'ãƒ›ãƒ¼ãƒ ', href: resolveUrl('/') },
  { name: 'ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹', href: resolveUrl('/analytics') },
];

// é™çš„ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
const issues = getIssuesWithFallback();
const isDataAvailable = hasStaticData();

// ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®è¨ˆç®—
const metrics = calculateMetrics(issues);

// ãƒãƒ£ãƒ¼ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
const issuesTrendData = convertIssuesTrendData(
  issues.slice(-30).map((issue: Issue, index: number) => ({
    timestamp: new Date(issue.created_at),
    value: index + 1,
  }))
);

const categoriesData = convertCategoriesData(issues);
const resolutionTimeData = convertResolutionTimeData(
  {
    averageResolutionTime: 0,
    medianResolutionTime: 0,
    resolutionRate: 0,
    responseTime: 0,
    throughput: 0,
    backlogSize: 0,
    burndownRate: 0,
  },
  issues
);
const contributorData = convertContributorData(issues);

// æœ€è¿‘ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£
const recentActivity = generateRecentActivity(issues);

// ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
let metadata = null;
try {
  if (isDataAvailable) {
    metadata = getStaticMetadata();
  }
} catch (error) {
  // eslint-disable-next-line no-console
  console.error('ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
}
---

<PageLayout
  title={title}
  description={description}
  breadcrumbs={breadcrumbs}
  showHeader={true}
  showFooter={true}
  showSearch={true}
  maxWidth="7xl"
  padding="lg"
  class="page-background"
>
  <div class="space-y-8">
    <PageHeader
      title="ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰"
      description="GitHubãƒªãƒã‚¸ãƒˆãƒªæ´»å‹•ã«é–¢ã™ã‚‹æ´å¯Ÿã¨åˆ†æ"
      icon="ğŸ“Š"
      metaInfo={{
        repositoryOwner: metadata?.repository?.owner,
        repositoryName: metadata?.repository?.name,
        lastUpdated: metadata ? new Date(metadata.lastUpdated) : undefined,
        dataSource: `${issues.length} issues analyzed`,
        isDataAvailable: isDataAvailable,
      }}
      warningMessage={!isDataAvailable
        ? 'ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ä¸­ - å®Ÿéš›ã®åˆ†æã«ã¯ npm run fetch-data ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„'
        : undefined}
    />

    <!-- Key Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 space-lg">
      <div class="card">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-muted">ç·Issueæ•°</p>
            <p class="text-2xl font-bold text-heading">{metrics.totalIssues}</p>
          </div>
          <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
            <span class="text-blue-600 text-xl">ğŸ“‹</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-muted">ã‚ªãƒ¼ãƒ—ãƒ³ãªIssue</p>
            <p class="text-2xl font-bold text-heading">{metrics.openIssues}</p>
          </div>
          <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
            <span class="text-green-600 text-xl">ğŸ”“</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-muted">ã‚¯ãƒ­ãƒ¼ã‚ºã—ãŸIssue</p>
            <p class="text-2xl font-bold text-heading">{metrics.closedIssues}</p>
          </div>
          <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
            <span class="text-gray-600 text-xl">ğŸ”’</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-muted">å¹³å‡è§£æ±ºæ™‚é–“</p>
            <p class="text-2xl font-bold text-heading">{metrics.averageResolutionTime}</p>
          </div>
          <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
            <span class="text-purple-600 text-xl">â±ï¸</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Interactive Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 space-lg">
      <!-- Issue Trend Chart -->
      <div class="h-80">
        <IssueTrendsChart
          client:load
          height={300}
          data={issuesTrendData}
          title="Issueä½œæˆãƒˆãƒ¬ãƒ³ãƒ‰"
        />
      </div>

      <!-- Issue Categories -->
      <div class="h-80">
        <IssueCategoriesChart
          client:load
          height={300}
          data={categoriesData}
          title="Issueã‚«ãƒ†ã‚´ãƒª"
        />
      </div>
    </div>

    <!-- Performance Metrics -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 space-lg">
      <div class="h-80">
        <ResolutionTimeChart
          client:load
          height={300}
          data={resolutionTimeData}
          title="è§£æ±ºæ™‚é–“ãƒˆãƒ¬ãƒ³ãƒ‰"
        />
      </div>

      <div class="h-80">
        <ContributorActivityChart
          client:load
          height={300}
          data={contributorData}
          title="ãƒˆãƒƒãƒ—ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ¼"
        />
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Recent Activity -->
      <div class="lg:col-span-2">
        <div class="card">
          <h2 class="text-lg font-semibold text-heading mb-4">æœ€è¿‘ã®æ´»å‹•</h2>
          <div class="space-y-4">
            {
              recentActivity.slice(0, 8).map(activity => (
                <div class="flex items-start gap-3">
                  <div
                    class={`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${
                      activity.type === 'closed'
                        ? 'bg-green-100'
                        : activity.type === 'opened'
                          ? 'bg-blue-100'
                          : 'bg-yellow-100'
                    }`}
                  >
                    <span
                      class={`text-sm ${
                        activity.type === 'closed'
                          ? 'text-green-600'
                          : activity.type === 'opened'
                            ? 'text-blue-600'
                            : 'text-yellow-600'
                      }`}
                    >
                      {activity.type === 'closed' ? 'âœ“' : activity.type === 'opened' ? '+' : 'ğŸ’¬'}
                    </span>
                  </div>
                  <div>
                    <p class="text-sm text-heading">
                      <a
                        href={resolveUrl(`/issues/${activity.issue.number}`)}
                        class="hover:text-blue-600"
                      >
                        {activity.description}
                      </a>
                    </p>
                    <p class="text-xs text-muted">{formatTimeAgo(activity.timestamp)}</p>
                  </div>
                </div>
              ))
            }
            {
              recentActivity.length === 0 && (
                <p class="text-sm text-muted text-center py-4">æœ€è¿‘ã®æ´»å‹•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>
              )
            }
          </div>
        </div>
      </div>

      <!-- Top Contributors -->
      <div class="lg:col-span-1">
        <div class="card">
          <h2 class="text-lg font-semibold text-heading mb-4">ãƒˆãƒƒãƒ—ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ¼</h2>
          <div class="space-y-3">
            {
              metrics.topContributors.map((contributor, index) => (
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full text-xs flex items-center justify-center">
                      {index + 1}
                    </span>
                    <span class="text-sm text-heading">@{contributor.name}</span>
                  </div>
                  <span class="text-sm text-muted">{contributor.count} issues</span>
                </div>
              ))
            }
            {
              metrics.topContributors.length === 0 && (
                <p class="text-sm text-muted text-center py-4">
                  ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“
                </p>
              )
            }
          </div>
        </div>
      </div>
    </div>

    <!-- AI Insights -->
    <div class="mt-8">
      <div class="card">
        <h2 class="text-lg font-semibold text-heading mb-4">ğŸ¤– AIæ´å¯Ÿ</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h3 class="font-medium text-heading mb-2">ä¸»è¦ãªç™ºè¦‹</h3>
            <ul class="space-y-2 text-sm text-muted">
              <li>â€¢ è¿½è·¡ä¸­ã®Issueç·æ•°: {metrics.totalIssues}ä»¶</li>
              <li>
                â€¢ ç¾åœ¨ã‚ªãƒ¼ãƒ—ãƒ³ãªIssue: {metrics.openIssues}ä»¶ ({
                  Math.round((metrics.openIssues / metrics.totalIssues) * 100)
                }%)
              </li>
              <li>
                â€¢ æœ€é »å‡ºãƒ©ãƒ™ãƒ«: {metrics.topLabels[0]?.name || 'ãªã—'} ({
                  metrics.topLabels[0]?.count || 0
                } ä»¶)
              </li>
              <li>â€¢ å¹³å‡è§£æ±ºæ™‚é–“: {metrics.averageResolutionTime}</li>
            </ul>
          </div>
          <div>
            <h3 class="font-medium text-heading mb-2">æ¨å¥¨äº‹é …</h3>
            <ul class="space-y-2 text-sm text-muted">
              {
                metrics.openIssues > metrics.closedIssues && (
                  <li>â€¢ ã‚ªãƒ¼ãƒ—ãƒ³ãªIssueã®ã‚¯ãƒ­ãƒ¼ã‚ºã«æ³¨åŠ›ã—ã¦è§£æ±ºç‡ã‚’å‘ä¸Šã•ã›ã‚‹</li>
                )
              }
              {
                metrics.topLabels.length > 0 && metrics.topLabels[0] && (
                  <li>â€¢ {metrics.topLabels[0].name}ã®Issueã‚’æ•´ç†ã—ã¦ã‚ˆã‚Šè‰¯ã„è¿½è·¡ã‚’æ¤œè¨ã™ã‚‹</li>
                )
              }
              <li>â€¢ ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ¼ã®æ´»å‹•ã‚’ç¢ºèªã—å‚åŠ ã‚’ä¿ƒé€²ã™ã‚‹</li>
              <li>â€¢ è‡ªå‹•Issueåˆ†é¡ã®è¨­å®šã‚’æ¤œè¨ã™ã‚‹</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</PageLayout>
