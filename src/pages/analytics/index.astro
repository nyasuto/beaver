---
/**
 * Analytics Dashboard Page
 *
 * This page displays analytics and insights about GitHub repository activity.
 * Integrates with Analytics Engine and GitHub data for real-time insights.
 */

import PageLayout from '../../components/layouts/PageLayout.astro';
import PageHeader from '../../components/ui/PageHeader.astro';
import {
  IssueTrendsChart,
  IssueCategoriesChart,
  ResolutionTimeChart,
  ContributorActivityChart,
} from '../../components/charts/AnalyticsCharts.tsx';

import { getIssuesWithFallback, hasStaticData, getStaticMetadata } from '../../lib/data/github';
import {
  calculateMetrics,
  convertIssuesTrendData,
  convertCategoriesData,
  convertResolutionTimeData,
  convertContributorData,
  generateRecentActivity,
  formatTimeAgo,
} from '../../lib/analytics/data-adapter';
import type { Issue } from '../../lib/schemas/github';
import { resolveUrl } from '../../lib/utils/url';

const title = 'アナリティクスダッシュボード';
const description = 'GitHubリポジトリ活動の分析と洞察を表示';

const breadcrumbs = [
  { name: 'ホーム', href: resolveUrl('/') },
  { name: 'アナリティクス', href: resolveUrl('/analytics') },
];

// 静的データの読み込み
const issues = getIssuesWithFallback();
const isDataAvailable = hasStaticData();

// メトリクスの計算
const metrics = calculateMetrics(issues);

// チャート用データの準備
const issuesTrendData = convertIssuesTrendData(
  issues.slice(-30).map((issue: Issue, index: number) => ({
    timestamp: new Date(issue.created_at),
    value: index + 1,
  }))
);

const categoriesData = convertCategoriesData(issues);
const resolutionTimeData = convertResolutionTimeData(
  {
    averageResolutionTime: 0,
    medianResolutionTime: 0,
    resolutionRate: 0,
    responseTime: 0,
    throughput: 0,
    backlogSize: 0,
    burndownRate: 0,
  },
  issues
);
const contributorData = convertContributorData(issues);

// 最近のアクティビティ
const recentActivity = generateRecentActivity(issues);

// メタデータ
let metadata = null;
try {
  if (isDataAvailable) {
    metadata = getStaticMetadata();
  }
} catch (error) {
  // eslint-disable-next-line no-console
  console.error('メタデータの読み込みに失敗しました:', error);
}
---

<PageLayout
  title={title}
  description={description}
  breadcrumbs={breadcrumbs}
  showHeader={true}
  showFooter={true}
  showSearch={true}
  maxWidth="7xl"
  padding="lg"
  class="page-background"
>
  <div class="space-y-8">
    <PageHeader
      title="アナリティクスダッシュボード"
      description="GitHubリポジトリ活動に関する洞察と分析"
      icon="📊"
      metaInfo={{
        repositoryOwner: metadata?.repository?.owner,
        repositoryName: metadata?.repository?.name,
        lastUpdated: metadata ? new Date(metadata.lastUpdated) : undefined,
        dataSource: `${issues.length} issues analyzed`,
        isDataAvailable: isDataAvailable,
      }}
      warningMessage={!isDataAvailable
        ? 'サンプルデータを使用中 - 実際の分析には npm run fetch-data を実行してください'
        : undefined}
    />

    <!-- Key Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 space-lg">
      <div class="card">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-muted">総Issue数</p>
            <p class="text-2xl font-bold text-heading">{metrics.totalIssues}</p>
          </div>
          <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
            <span class="text-blue-600 text-xl">📋</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-muted">オープンなIssue</p>
            <p class="text-2xl font-bold text-heading">{metrics.openIssues}</p>
          </div>
          <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
            <span class="text-green-600 text-xl">🔓</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-muted">クローズしたIssue</p>
            <p class="text-2xl font-bold text-heading">{metrics.closedIssues}</p>
          </div>
          <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
            <span class="text-gray-600 text-xl">🔒</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-muted">平均解決時間</p>
            <p class="text-2xl font-bold text-heading">{metrics.averageResolutionTime}</p>
          </div>
          <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
            <span class="text-purple-600 text-xl">⏱️</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Interactive Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 space-lg">
      <!-- Issue Trend Chart -->
      <div class="h-80">
        <IssueTrendsChart
          client:load
          height={300}
          data={issuesTrendData}
          title="Issue作成トレンド"
        />
      </div>

      <!-- Issue Categories -->
      <div class="h-80">
        <IssueCategoriesChart
          client:load
          height={300}
          data={categoriesData}
          title="Issueカテゴリ"
        />
      </div>
    </div>

    <!-- Performance Metrics -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 space-lg">
      <div class="h-80">
        <ResolutionTimeChart
          client:load
          height={300}
          data={resolutionTimeData}
          title="解決時間トレンド"
        />
      </div>

      <div class="h-80">
        <ContributorActivityChart
          client:load
          height={300}
          data={contributorData}
          title="トップコントリビューター"
        />
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Recent Activity -->
      <div class="lg:col-span-2">
        <div class="card">
          <h2 class="text-lg font-semibold text-heading mb-4">最近の活動</h2>
          <div class="space-y-4">
            {
              recentActivity.slice(0, 8).map(activity => (
                <div class="flex items-start gap-3">
                  <div
                    class={`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${
                      activity.type === 'closed'
                        ? 'bg-green-100'
                        : activity.type === 'opened'
                          ? 'bg-blue-100'
                          : 'bg-yellow-100'
                    }`}
                  >
                    <span
                      class={`text-sm ${
                        activity.type === 'closed'
                          ? 'text-green-600'
                          : activity.type === 'opened'
                            ? 'text-blue-600'
                            : 'text-yellow-600'
                      }`}
                    >
                      {activity.type === 'closed' ? '✓' : activity.type === 'opened' ? '+' : '💬'}
                    </span>
                  </div>
                  <div>
                    <p class="text-sm text-heading">
                      <a
                        href={resolveUrl(`/issues/${activity.issue.number}`)}
                        class="hover:text-blue-600"
                      >
                        {activity.description}
                      </a>
                    </p>
                    <p class="text-xs text-muted">{formatTimeAgo(activity.timestamp)}</p>
                  </div>
                </div>
              ))
            }
            {
              recentActivity.length === 0 && (
                <p class="text-sm text-muted text-center py-4">最近の活動が見つかりません</p>
              )
            }
          </div>
        </div>
      </div>

      <!-- Top Contributors -->
      <div class="lg:col-span-1">
        <div class="card">
          <h2 class="text-lg font-semibold text-heading mb-4">トップコントリビューター</h2>
          <div class="space-y-3">
            {
              metrics.topContributors.map((contributor, index) => (
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full text-xs flex items-center justify-center">
                      {index + 1}
                    </span>
                    <span class="text-sm text-heading">@{contributor.name}</span>
                  </div>
                  <span class="text-sm text-muted">{contributor.count} issues</span>
                </div>
              ))
            }
            {
              metrics.topContributors.length === 0 && (
                <p class="text-sm text-muted text-center py-4">
                  コントリビューターデータが見つかりません
                </p>
              )
            }
          </div>
        </div>
      </div>
    </div>

    <!-- AI Insights -->
    <div class="mt-8">
      <div class="card">
        <h2 class="text-lg font-semibold text-heading mb-4">🤖 AI洞察</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h3 class="font-medium text-heading mb-2">主要な発見</h3>
            <ul class="space-y-2 text-sm text-muted">
              <li>• 追跡中のIssue総数: {metrics.totalIssues}件</li>
              <li>
                • 現在オープンなIssue: {metrics.openIssues}件 ({
                  Math.round((metrics.openIssues / metrics.totalIssues) * 100)
                }%)
              </li>
              <li>
                • 最頻出ラベル: {metrics.topLabels[0]?.name || 'なし'} ({
                  metrics.topLabels[0]?.count || 0
                } 件)
              </li>
              <li>• 平均解決時間: {metrics.averageResolutionTime}</li>
            </ul>
          </div>
          <div>
            <h3 class="font-medium text-heading mb-2">推奨事項</h3>
            <ul class="space-y-2 text-sm text-muted">
              {
                metrics.openIssues > metrics.closedIssues && (
                  <li>• オープンなIssueのクローズに注力して解決率を向上させる</li>
                )
              }
              {
                metrics.topLabels.length > 0 && metrics.topLabels[0] && (
                  <li>• {metrics.topLabels[0].name}のIssueを整理してより良い追跡を検討する</li>
                )
              }
              <li>• コントリビューターの活動を確認し参加を促進する</li>
              <li>• 自動Issue分類の設定を検討する</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</PageLayout>
