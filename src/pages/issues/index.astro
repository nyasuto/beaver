---
/**
 * Issues List Page
 *
 * This page displays a list of GitHub issues with filtering and search capabilities.
 * Data is loaded from static JSON files generated by scripts/fetch-github-data.ts
 */

import PageLayout from '../../components/layouts/PageLayout.astro';
import PageHeader from '../../components/ui/PageHeader.astro';
import {
  getIssuesWithFallback,
  getStaticMetadata,
  hasStaticData,
  getLastUpdated,
} from '../../lib/data/github';
import { resolveUrl } from '../../lib/utils/url';

const title = 'Issue';
const description = 'AIæ­è¼‰ã®æ´å¯Ÿã§GitHubã®Issueã‚’é–²è¦§ãƒ»åˆ†æ';

// é™çš„ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
let issues = getIssuesWithFallback();
let metadata = null;
let lastUpdated = null;
let isDataAvailable = hasStaticData();

try {
  if (isDataAvailable) {
    metadata = getStaticMetadata();
    lastUpdated = getLastUpdated();

    // æœ€æ–°ã® Issue ã‚’å…ˆé ­ã«è¡¨ç¤º
    issues = issues.sort(
      (a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
    );
  }
} catch (error) {
  // eslint-disable-next-line no-console
  console.error('ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
  isDataAvailable = false;
}

const openIssues = issues.filter(issue => issue.state === 'open');
const closedIssues = issues.filter(issue => issue.state === 'closed');

// ãƒ©ãƒ™ãƒ«ã®é›†è¨ˆ
const labelCounts = issues.reduce(
  (acc, issue) => {
    issue.labels.forEach(label => {
      acc[label.name] = (acc[label.name] || 0) + 1;
    });
    return acc;
  },
  {} as Record<string, number>
);

const sortedLabels = Object.entries(labelCounts)
  .sort(([, a], [, b]) => b - a)
  .slice(0, 10); // ä¸Šä½10ãƒ©ãƒ™ãƒ«ã®ã¿è¡¨ç¤º
---

<PageLayout
  title={title}
  description={description}
  showHeader={true}
  showFooter={true}
  showSearch={false}
  maxWidth="7xl"
  padding="lg"
  class="page-background"
>
  <PageHeader
    title="Issue"
    description="AIæ­è¼‰ã®åˆ†é¡ã¨æ´å¯Ÿã§GitHubã®Issueã‚’é–²è¦§ãƒ»åˆ†æ"
    icon="ğŸ“‹"
    metaInfo={{
      totalCount: issues.length,
      openCount: openIssues.length,
      closedCount: closedIssues.length,
      lastUpdated: lastUpdated || undefined,
      repositoryOwner: metadata?.repository?.owner,
      repositoryName: metadata?.repository?.name,
      isDataAvailable: isDataAvailable,
    }}
  />

  <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 space-lg">
    <!-- Filters Sidebar -->
    <aside class="lg:col-span-1">
      <div class="card">
        <h2 class="text-lg font-semibold text-heading mb-4">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h2>
        <div class="space-y-4">
          <div>
            <label class="label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
            <select class="input" id="status-filter">
              <option value="all">ã™ã¹ã¦ ({issues.length})</option>
              <option value="open">ã‚ªãƒ¼ãƒ—ãƒ³ ({openIssues.length})</option>
              <option value="closed">ã‚¯ãƒ­ãƒ¼ã‚º ({closedIssues.length})</option>
            </select>
          </div>

          <div>
            <label class="label">ãƒ©ãƒ™ãƒ«</label>
            <div class="space-y-2 max-h-48 overflow-y-auto">
              {
                sortedLabels.map(([labelName, count]) => (
                  <label class="flex items-center">
                    <input type="checkbox" class="mr-2" value={labelName} />
                    <span class="text-sm flex-1">{labelName}</span>
                    <span class="text-xs text-muted">({count})</span>
                  </label>
                ))
              }
            </div>
          </div>

          {
            isDataAvailable && metadata && (
              <div class="pt-4 border-t">
                <h3 class="text-sm font-medium text-heading mb-2">ãƒªãƒã‚¸ãƒˆãƒª</h3>
                <p class="text-sm text-muted">
                  {metadata.repository.owner}/{metadata.repository.name}
                </p>
              </div>
            )
          }
        </div>
      </div>
    </aside>

    <!-- Issues List -->
    <div class="lg:col-span-3">
      <div class="card">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
          <h2 class="text-lg font-semibold text-heading">Issueä¸€è¦§</h2>
          <div class="flex gap-2 mt-2 sm:mt-0">
            <input
              type="search"
              placeholder="Issueã‚’æ¤œç´¢..."
              class="input w-64"
              id="search-input"
            />
            <button class="btn btn-primary" id="search-button">æ¤œç´¢</button>
          </div>
        </div>

        <div class="space-y-4" id="issues-container">
          {
            issues.length === 0 && (
              <div class="text-center py-8">
                <p class="text-muted">
                  {isDataAvailable
                    ? 'Issue ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'
                    : 'ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã«ã¯ npm run fetch-data ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„'}
                </p>
              </div>
            )
          }

          {
            issues.map(issue => (
              <div
                class="p-4 border rounded-md issue-card"
                data-state={issue.state}
                data-labels={issue.labels.map(l => l.name).join(',')}
              >
                <div class="flex justify-between items-start mb-2">
                  <div class="flex-1">
                    <h3 class="font-medium text-heading">
                      <a href={resolveUrl(`/issues/${issue.number}`)} class="hover:text-blue-600">
                        {issue.title}
                      </a>
                    </h3>
                    <p class="text-sm text-muted">
                      #{issue.number} â€¢ {issue.state === 'open' ? 'ğŸŸ¢' : 'ğŸ”´'}{' '}
                      {issue.state === 'open' ? 'ã‚ªãƒ¼ãƒ—ãƒ³' : 'ã‚¯ãƒ­ãƒ¼ã‚º'} â€¢
                      {issue.user?.login || 'Unknown'} â€¢
                      {new Date(issue.created_at).toLocaleDateString('ja-JP')}
                    </p>
                  </div>
                  <div class="ml-4">
                    <span
                      class={`px-2 py-1 text-xs rounded font-medium ${
                        issue.state === 'open'
                          ? 'bg-green-100 text-green-800'
                          : 'bg-gray-100 text-gray-800'
                      }`}
                    >
                      {issue.state === 'open' ? 'ã‚ªãƒ¼ãƒ—ãƒ³' : 'ã‚¯ãƒ­ãƒ¼ã‚º'}
                    </span>
                  </div>
                </div>

                {issue.body && (
                  <p class="text-sm text-muted mt-2 line-clamp-3">
                    {issue.body.substring(0, 200)}
                    {issue.body.length > 200 && '...'}
                  </p>
                )}

                {issue.labels.length > 0 && (
                  <div class="flex flex-wrap gap-1 mt-3">
                    {issue.labels.map(label => (
                      <span
                        class="px-2 py-1 text-xs rounded"
                        style={`background-color: #${label.color}20; color: #${label.color}`}
                      >
                        {label.name}
                      </span>
                    ))}
                  </div>
                )}

                <div class="flex justify-between items-center mt-3 pt-3 border-t text-xs text-muted">
                  <span>ä½œæˆ: {new Date(issue.created_at).toLocaleDateString('ja-JP')}</span>
                  <span>æ›´æ–°: {new Date(issue.updated_at).toLocaleDateString('ja-JP')}</span>
                </div>
              </div>
            ))
          }
        </div>

        {
          isDataAvailable && (
            <div class="mt-6 text-center">
              <p class="text-muted text-sm">{issues.length} ä»¶ã® Issue ã‚’è¡¨ç¤ºä¸­</p>
            </div>
          )
        }
      </div>
    </div>
  </div>
</PageLayout>
