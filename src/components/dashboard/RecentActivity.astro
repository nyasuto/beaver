---
/**
 * Recent Activity Component
 *
 * Displays recent issue activity and commit information
 * Using unified StatsService for consistent data across components
 */

import { formatDistanceToNow } from 'date-fns';
import { getStatsService } from '../../lib/services/StatsService';

// Get unified statistics using the StatsService
const statsService = getStatsService();
const statsResult = await statsService.getUnifiedStats({
  includeRecentActivity: true,
  includePriorityBreakdown: true,
  includeLabels: true,
  recentDays: 7,
  maxRecentItems: 10,
});

// Extract data from unified stats
const stats = statsResult.success ? statsResult.data : null;

// Fetch repository data separately (as it's not part of unified stats)
const fetchRepositoryData = async () => {
  try {
    const response = await fetch(
      `${Astro.site?.origin || 'http://localhost:4321'}/api/github/repository?include_stats=true`
    );

    if (response.ok) {
      const result = await response.json();
      if (result.success) {
        return {
          success: true,
          data: {
            repository: result.data?.repository || null,
            lastPush: result.data?.repository?.pushed_at || null,
          },
        };
      }
    }
  } catch (error) {
    // eslint-disable-next-line no-console
    console.error('Failed to fetch repository data:', error);
  }

  return {
    success: false,
    data: {
      repository: null,
      lastPush: null,
    },
  };
};

const repoResult = await fetchRepositoryData();
const { repository, lastPush } = repoResult.data;

// Helper function to get issue icon based on state and labels
const getIssueIcon = (issue: any) => {
  if (issue.state === 'closed') return 'âœ…';
  if (issue.pull_request) return 'ðŸ”„';

  // Check for priority labels
  const labels = issue.labels || [];
  const priorityLabel = labels.find(
    (label: any) => label.name && label.name.startsWith('priority:')
  );

  if (priorityLabel) {
    const priority = priorityLabel.name.split(':')[1]?.trim();
    switch (priority) {
      case 'critical':
        return 'ðŸš¨';
      case 'high':
        return 'ðŸ”´';
      case 'medium':
        return 'ðŸŸ¡';
      case 'low':
        return 'ðŸŸ¢';
      default:
        return 'ðŸ“„';
    }
  }

  return 'ðŸ“„';
};

// Helper function to get relative time
const getRelativeTime = (dateString: string) => {
  try {
    return formatDistanceToNow(new Date(dateString), { addSuffix: true });
  } catch {
    return 'recently';
  }
};

// Get recent issues from unified stats
const recentIssues = stats?.recentActivity.recentlyUpdated || [];

// Export interface for type checking
export interface Props {
  class?: string;
}

const { class: className = '' } = Astro.props;
---

<div class={`space-y-6 ${className}`}>
  <!-- Recent Issues Activity -->
  <div class="card">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Recent Issues</h3>
      <a
        href="/issues"
        class="text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300"
      >
        View all â†’
      </a>
    </div>

    <div class="space-y-3">
      {
        recentIssues.length > 0 ? (
          recentIssues.map((issue: any) => (
            <div class="flex items-start space-x-3 p-3 border border-gray-100 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
              <span class="text-lg mt-0.5">{getIssueIcon(issue)}</span>
              <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between">
                  <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 dark:text-white truncate">
                      {issue.title}
                    </p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                      #{issue.number} â€¢ {issue.state} â€¢ {getRelativeTime(issue.updated_at)}
                    </p>
                  </div>
                  <div class="flex items-center space-x-1 ml-2">
                    {issue.labels?.slice(0, 2).map((label: any) => (
                      <span
                        class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                        style={`background-color: #${label.color}20; color: #${label.color};`}
                      >
                        {label.name}
                      </span>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          ))
        ) : (
          <div class="text-center py-8 text-gray-500 dark:text-gray-400">
            <span class="text-2xl block mb-2">ðŸ“­</span>
            <p class="text-sm">No recent issues found</p>
          </div>
        )
      }
    </div>
  </div>

  <!-- Repository Activity -->
  <div class="card">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Repository Activity</h3>
      <a
        href="/analytics"
        class="text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300"
      >
        View analytics â†’
      </a>
    </div>

    <div class="space-y-3">
      {
        repository && (
          <div class="flex items-center space-x-3 p-3 border border-gray-100 dark:border-gray-700 rounded-lg">
            <span class="text-lg">ðŸ“‚</span>
            <div class="flex-1">
              <p class="text-sm font-medium text-gray-900 dark:text-white">Repository Health</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">
                {repository.stargazers_count} stars â€¢ {repository.forks_count} forks â€¢{' '}
                {repository.open_issues_count} open issues
              </p>
            </div>
          </div>
        )
      }

      {
        lastPush && (
          <div class="flex items-center space-x-3 p-3 border border-gray-100 dark:border-gray-700 rounded-lg">
            <span class="text-lg">ðŸ“¤</span>
            <div class="flex-1">
              <p class="text-sm font-medium text-gray-900 dark:text-white">Latest Push</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">{getRelativeTime(lastPush)}</p>
            </div>
          </div>
        )
      }

      <!-- Weekly Summary -->
      <div
        class="flex items-center space-x-3 p-3 border border-gray-100 dark:border-gray-700 rounded-lg"
      >
        <span class="text-lg">ðŸ“Š</span>
        <div class="flex-1">
          <p class="text-sm font-medium text-gray-900 dark:text-white">This Week</p>
          <p class="text-xs text-gray-500 dark:text-gray-400">
            {stats?.recentActivity.thisWeek || 0} issues updated
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Data Source Information -->
<div class="mt-4 flex items-center justify-between text-sm text-gray-500">
  <span>
    Issues data: {stats?.meta.source || 'unknown'}
    {stats?.meta.source === 'cache' && ' (cached)'}
    {' â€¢ '}
    Repository data: {repoResult.success ? 'github_api' : 'unavailable'}
  </span>
  <span>
    Last updated: {
      stats?.meta.generated_at ? new Date(stats.meta.generated_at).toLocaleString() : 'unknown'
    }
  </span>
</div>

<!-- API Status Warning -->
{
  (!statsResult.success || !repoResult.success) && (
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg
            class="h-5 w-5 text-yellow-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"
            />
          </svg>
        </div>
        <div class="ml-3">
          <p class="text-sm text-yellow-700">
            {!statsResult.success && 'Unable to fetch recent activity. '}
            {!repoResult.success && 'Unable to fetch repository data. '}
            Please check your
            <a
              href="/api/github/health"
              class="font-medium underline text-yellow-700 hover:text-yellow-600"
            >
              GitHub API connection
            </a>
            .
          </p>
        </div>
      </div>
    </div>
  )
}
