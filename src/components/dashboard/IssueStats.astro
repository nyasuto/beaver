---
/**
 * Issue Statistics Component
 *
 * Displays the most important issue statistics for quick overview
 * Simplified to show only essential metrics
 */

import StatCard from './StatCard.astro';
import { getStatsService } from '../../lib/services/StatsService';

// Get unified statistics using the StatsService
const statsService = getStatsService();
const statsResult = await statsService.getUnifiedStats({
  includeRecentActivity: true,
  includePriorityBreakdown: true,
  includeLabels: false,
  recentDays: 7,
});

// Extract data from unified stats
const stats = statsResult.success ? statsResult.data : null;

// Calculate derived metrics
const urgentIssues = stats ? stats.priority.critical + stats.priority.high : 0;
const recentActivity = stats ? stats.recentActivity.thisWeek : 0;

// Export interface for type checking
export interface Props {
  class?: string;
}

const { class: className = '' } = Astro.props;
---

<div class={`grid grid-cols-1 md:grid-cols-3 gap-6 ${className}`}>
  <!-- Open Issues -->
  <StatCard
    title="Open Issues"
    value={stats?.open || 0}
    icon="🔓"
    description="Currently active"
    color="green"
  />

  <!-- Urgent Issues -->
  <StatCard
    title="Urgent Issues"
    value={urgentIssues}
    icon="🚨"
    description="Critical & high priority"
    color="red"
  />

  <!-- Recent Activity -->
  <StatCard
    title="Recent Activity"
    value={recentActivity}
    icon="📈"
    description="Updated this week"
    color="blue"
  />
</div>

<!-- Data Source Status -->
{
  stats?.meta.source === 'fallback' && (
    <div class="mt-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg">
      <p class="text-sm text-yellow-700 dark:text-yellow-300">
        ⚠️ サンプルデータを表示中 -
        <a href="/api/github/health" class="underline hover:no-underline">
          GitHub API接続を確認
        </a>
        して実際のデータを取得してください
      </p>
    </div>
  )
}
{
  stats?.meta.source === 'static_data' && (
    <div class="mt-4 p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
      <p class="text-sm text-green-700 dark:text-green-300">
        ✅ 静的データを使用中 - 最新データを取得するには `npm run fetch-data` を実行してください
      </p>
    </div>
  )
}
